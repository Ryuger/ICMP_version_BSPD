# /etc/nginx/nginx.conf (fragment)
user nginx;
worker_processes auto;

events { worker_connections 1024; }

http {
    server_tokens off;

    # If NGINX sits on the same host as the backend:
    # set_real_ip_from 127.0.0.1;
    # real_ip_header X-Forwarded-For;
    # real_ip_recursive on;
    #
    # If there is a trusted proxy/LB in front of NGINX:
    set_real_ip_from 10.0.0.0/24;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    geo $is_whitelisted {
        default 0;
        include /etc/nginx/ip_whitelist.conf;   # "10.0.0.5 1;" or "10.0.0.0/24 1;"
    }

    geo $is_blacklisted {
        default 0;
        include /etc/nginx/ip_blacklist.conf;   # "10.0.0.5 1;"
    }

    # Collapse into a single deny flag
    map "$is_whitelisted$is_blacklisted" $deny_all {
        default 1;   # deny by default
        "10" 0;      # whitelisted=1, blacklisted=0 => allow
        "11" 1;      # whitelisted & blacklisted => deny
        "00" 1;
        "01" 1;
    }

    limit_req_zone $binary_remote_addr zone=login_zone:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=api_zone:10m rate=30r/m;

    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    server {
        listen 443 ssl http2;
        server_name intranet.example.local;

        ssl_certificate     /etc/ssl/internal_ca/server.crt;
        ssl_certificate_key /etc/ssl/internal_ca/server.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        # "Don't even see a page"
        if ($deny_all) { return 444; }

        # Security headers
        add_header Content-Security-Policy "default-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer" always;
        add_header Permissions-Policy "geolocation=(), camera=(), microphone=()" always;
        add_header X-Frame-Options "DENY" always;

        client_max_body_size 1m;

        location = /login {
            limit_req zone=login_zone burst=3 nodelay;
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location / {
            limit_req zone=api_zone burst=10 nodelay;
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
