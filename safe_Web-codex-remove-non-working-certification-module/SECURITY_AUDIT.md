# Аудит информационной безопасности safe_Web

## Что уже исправлено в коде
1. **Разделение на процессы по ролям**: добавлен `SERVER_ROLE` (`public|admin|all`). Теперь можно запускать публичный и админский интерфейсы как **разные процессы** (рекомендуемый режим — два отдельных запуска). 
2. **TLS включён по умолчанию**: `PUBLIC_TLS_ENABLED=true` и `ADMIN_TLS_ENABLED=true` по default.
3. **Снижен риск memory-DoS в rate limiter**: добавлена очистка устаревших ключей в лимитере.
4. **Усилена изоляция админ-функций от клиентской стороны**: на публичном интерфейсе пути `/admin` и `/admin/*` принудительно блокируются, а CSRF-cookie разделены для public/admin.

## Как система обеспечивает ИБ
- Разделение поверхностей атаки: отдельные mux/server для public/admin.
- IP-контроль (whitelist + ban после неудачных логинов).
- bcrypt (`cost=12`) + dummy hash для несуществующих пользователей.
- Сессии и CSRF-токены, `HttpOnly` + `SameSite=Strict` cookie.
- Базовые security headers.
- Аудит действий в БД.

## Что всё ещё остаётся риском
### Высокий
1. **Рабочая SQLite БД в репозитории (`data/safe_web.db*`)**.
   - Риск утечки данных/хэшей.
   - Нужно: убрать из Git и добавить в `.gitignore`.

2. **IP определяется через `RemoteAddr` без trusted-proxy режима**.
   - Риск ошибок безопасности за reverse proxy.
   - Нужно: явный список доверенных прокси + безопасный разбор `X-Forwarded-For`.

### Средний
3. **CSP для `/app` с `unsafe-inline`**.
   - Нужно перейти на nonce/hash-based CSP.

4. **Сессии in-memory**.
   - Для HA/кластеров нужно внешнее хранилище сессий.

## Приоритет исправлений
1. Удалить БД/бинарные артефакты из репозитория.
2. Добавить trusted-proxy модель для IP.
3. Ужесточить CSP.
4. Вынести сессии в централизованное хранилище для production-HA.

## Заглушки/временные элементы
- `bootstrapMemoryUser` — dev/bootstrap сценарий для memory-store.
- `local /healthz` — технический endpoint.

## Вывод
Базовые механизмы ИБ реализованы, и часть критичных проблем уже закрыта (role-based process split + TLS-by-default). Остались в основном эксплуатационные и инфраструктурные риски.
