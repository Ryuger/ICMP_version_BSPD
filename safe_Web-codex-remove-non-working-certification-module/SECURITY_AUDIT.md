# Аудит информационной безопасности safe_Web

## Что проверено
- Архитектура HTTP/TLS и разделение публичного/админ интерфейсов.
- Аутентификация, сессии, CSRF, ограничения по IP/whitelist.
- Хранение секретов и состояние репозитория (включая артефакты в `data/`).
- Наличие заглушек/временных решений вместо «боевой» функциональности.

## Как система пытается обеспечивать ИБ
1. **Разделение поверхностей атаки**: публичный и админский интерфейсы поднимаются отдельными mux/server, админ по умолчанию слушает только loopback `127.0.0.1:9443`.
2. **IP-контроль**: для публичной части включена проверка whitelist + бан по серии неудачных логинов.
3. **Защита аутентификации**: bcrypt (cost=12), dummy hash при несуществующем пользователе для снижения user-enumeration.
4. **Сессионная модель**: случайные токены сессии/CSRF, HttpOnly/SameSite=Strict cookie, TTL для сессий.
5. **Базовые secure headers**: CSP, X-Frame-Options, no-store, nosniff, referrer policy.
6. **Аудит**: логирование админских и пользовательских событий в БД.

## Получается ли у системы сохранять ИБ на практике
**Частично да**, но есть критичные/высокие риски конфигурации и эксплуатации.

### Критично
1. **TLS выключен по умолчанию для обеих поверхностей (`PUBLIC_TLS_ENABLED=false`, `ADMIN_TLS_ENABLED=false`)**.
   - Риск: передача логинов/паролей и cookie в открытом виде при любом неидеальном сетевом контуре.
   - Рекомендация: включить TLS по умолчанию и/или жёстко требовать TLS вне dev-режима.

2. **В репозитории лежит рабочая SQLite база `data/safe_web.db` с учетными записями**.
   - Риск: утечка пользователей/структуры БД, офлайн-брут хэшей, компрометация тестовых/боевых данных.
   - Рекомендация: удалить `data/*.db*` из Git, добавить в `.gitignore`, оставить только миграции/seed-шаблоны.

### Высокий
3. **Проверка источника IP основана только на `RemoteAddr`**.
   - Риск: при reverse proxy/gateway логика whitelist/admin-loopback работает не как ожидается (может сломаться и в худшую, и в лучшую сторону в зависимости от топологии).
   - Рекомендация: сделать явный trusted-proxy режим с безопасным разбором `X-Forwarded-For`/`X-Real-IP` только от доверенных прокси.

4. **Админ-доступ «только loopback» легко неверно развернуть в контейнерах/прокси**.
   - Риск: внешние запросы могут попадать как локальные при нестрогой прокси-схеме.
   - Рекомендация: дополнить mTLS/VPN или дополнительной сетью управления, а не полагаться только на loopback-проверку приложения.

### Средний
5. **CSP для `/app` разрешает `unsafe-inline` для script/style**.
   - Риск: при XSS в шаблонах уязвимость эксплуатируется проще.
   - Рекомендация: перейти на nonce/hash-based CSP и убрать `unsafe-inline`.

6. **Сессии in-memory**.
   - Риск: после рестарта все сессии теряются; в HA-сценарии не масштабируется; есть риск нестабильного поведения безопасности при нескольких инстансах.
   - Рекомендация: вынести в централизованное сессионное хранилище (Redis/DB) с ротацией.

## Какие части кода исправлять в первую очередь
1. **Политика TLS по умолчанию и fail-fast без TLS в production** (`cmd/server/main.go`).
2. **Удалить БД/артефакты из репозитория и зафиксировать правила хранения секретных данных** (`data/safe_web.db*`).
3. **Безопасная модель работы за прокси** (`clientIP`, `ipGuard`, `adminIPGuard` в `cmd/server/main.go`).
4. **Ужесточение CSP** (`securityHeaders` в `cmd/server/main.go`).
5. **Операционные меры**: ротация bootstrap-паролей, секрет-менеджер для env.

## Есть ли заглушки/временные реализации
1. **`bootstrapMemoryUser`** — вспомогательная функция для memory-store сценариев, по сути dev/bootstrap-механика.
2. **`local /healthz` endpoint** — минималистичный служебный endpoint без аутентификации (допустимо, но это именно тех. endpoint).
3. **`icmpmon.exe` и артефакты БД в репозитории** — похоже на «приложенные бинарники/данные», а не на чистую reproducible-сборку; это не заглушка, но operational anti-pattern.

## Общий вывод
Система реализует базовые механизмы ИБ (bcrypt, сессии, CSRF, аудит, IP whitelist), но **в текущем виде требует усиления эксплуатационной безопасности**. Наибольший риск сейчас — **конфигурация TLS и хранение БД с учетными данными в репозитории**.
