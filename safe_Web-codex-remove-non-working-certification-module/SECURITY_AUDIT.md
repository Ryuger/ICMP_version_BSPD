# Аудит информационной безопасности safe_Web (повторный)

## Что проверено повторно
- Изоляция public/admin поверхностей после введения `SERVER_ROLE`.
- Возможность доступа к админ-путям со стороны клиентского интерфейса.
- CSRF-разделение между public/admin.
- Журналирование и видимость событий в админском интерфейсе.
- Оставшиеся риски из прошлого аудита.

## Текущий статус защиты
### Что работает корректно
1. **Разделение ролей процесса**: можно запускать как `SERVER_ROLE=public` и `SERVER_ROLE=admin` отдельными процессами.
2. **Доступ к админке с public-порта заблокирован**: `/admin` и `/admin/*` принудительно отклоняются на публичной поверхности.
3. **Админ-маршруты требуют loopback + admin-session**.
4. **CSRF разделён по зонам**: отдельные cookie для public/admin, исключено кросс-использование токенов.
5. **TLS включен по умолчанию** для public/admin.
6. **Rate-limiter очищает устаревшие ключи**, снижая риск накопления мусорного состояния.

### Что остаётся риском
#### Высокий
1. **Рабочая SQLite БД в репозитории (`data/safe_web.db*`)**.
   - Риск утечки служебных/учётных данных и офлайн-анализа хэшей.
   - Действие: удалить из Git, оставить только schema/migrations/test fixtures.

2. **Определение IP только по `RemoteAddr` (без trusted proxy)**.
   - Риск неверных security-решений за reverse proxy/ingress.
   - Действие: добавить режим доверенных прокси и безопасный разбор `X-Forwarded-For`.

#### Средний
3. **CSP для `/app` допускает `unsafe-inline`**.
   - Действие: перейти на nonce/hash CSP.

4. **Сессии in-memory**.
   - Риск функциональных/ИБ проблем в HA/мульти-инстанс сценариях.
   - Действие: вынести сессии в Redis/DB.

## Проверка на «нельзя вытащить админ-функции с клиентской стороны»
- С public-интерфейса админские пути не обслуживаются и отбрасываются.
- Операции whitelist/client/settings доступны только через admin-роуты под adminAuth.
- CSRF-cookie admin не подменяется public-cookie (разделение имён cookie).

## Вывод
На текущем этапе защита от прямого доступа к админ-функциям через клиентскую поверхность заметно усилена.
Ключевые оставшиеся риски — в основном инфраструктурные/операционные (репозиторий с БД, trusted-proxy, CSP, централизованные сессии).
