# safe_Web — инструкция «для чайников»

Это один Go-бинарник, который можно запускать в разных ролях:
- `SERVER_ROLE=public` — только публичный интерфейс.
- `SERVER_ROLE=admin` — только админка.
- `SERVER_ROLE=all` — оба интерфейса (режим по умолчанию для совместимости).

---

## 1) Что важно знать сразу

1. **Админка доступна только локально** (на сервере), по адресу `127.0.0.1`.
2. **Публичная часть** открывается на выбранном адресе/порту (по умолчанию `:8443`).
3. **Без создания админа через env** войти в админку не получится.
4. **Логин/пароль админа задаются при запуске через переменные окружения**:
   - `BOOTSTRAP_ADMIN_USER`
   - `BOOTSTRAP_ADMIN_PASSWORD`

Именно это и есть «изначальные» учётные данные админа для первого старта.

---

## 2) Быстрый запуск (Windows PowerShell)

> Ниже минимальный рабочий вариант для локального старта.

```powershell
# Публичный сервер (для клиентов)
$env:LISTEN_PUBLIC_ADDR = ":8443"

# Админка (только локально!)
$env:LISTEN_ADMIN_ADDR = "127.0.0.1:9443"

# Сертификат публичного HTTPS
$env:PUBLIC_CERT_PATH = "config/cert.pem"
$env:PUBLIC_KEY_PATH = "config/key.pem"

# Создание первого админа при старте
$env:BOOTSTRAP_ADMIN_USER = "localadmin"
$env:BOOTSTRAP_ADMIN_PASSWORD = "ChangeMeNow!"

# Запуск
go run ./cmd/server
```

---


## 2.1) Рекомендованный запуск как **два процесса**

Публичный интерфейс:
```powershell
$env:SERVER_ROLE = "public"
go run ./cmd/server
```

Админский интерфейс (на той же машине):
```powershell
$env:SERVER_ROLE = "admin"
go run ./cmd/server
```

Так атака на public-процесс не «заберёт» напрямую event loop админки (процессы раздельные).

---

## 3) Где взять cert.pem/key.pem

Для теста можно сделать самоподписанный сертификат:

```powershell
openssl req -x509 -newkey rsa:4096 -keyout config/key.pem -out config/cert.pem -days 365 -nodes -subj "/CN=localhost"
```

---

## 4) Как войти в админку

После запуска откройте на **самом сервере**:
- `http://127.0.0.1:9443/` (если `ADMIN_TLS_ENABLED=false`)
- или `https://127.0.0.1:9443/` (если `ADMIN_TLS_ENABLED=true`)

С `/` будет редирект на `/admin/login`.

Логин/пароль:
- логин = значение `BOOTSTRAP_ADMIN_USER`
- пароль = значение `BOOTSTRAP_ADMIN_PASSWORD`

---

## 5) Откуда берутся «первые» логины/пароли

### Админ
Берётся из env при запуске:
- `BOOTSTRAP_ADMIN_USER`
- `BOOTSTRAP_ADMIN_PASSWORD`

### Обычные пользователи
Создаются **только через админку**:
1. Создаёте клиента.
2. Открываете клиента.
3. Создаёте пользователя (username/password).
4. Сразу указываете его IP/CIDR для whitelist.

Без админки создание пользователей/клиентов не предусмотрено.

---

## 6) Основной функционал админки

### `/admin/clients`
- Создание клиента.

### `/admin/clients/{id}`
- Включить/выключить клиента.
- Создать пользователя для клиента (логин/пароль).
- Добавить whitelist-адрес для пользователя при создании.

### `/admin/whitelist`
- Ручное добавление IP/CIDR (manual).
- Просмотр, чей адрес (owner_type / owner_id / label).
- Удаление записей.

### `/admin/settings`
- Переключатели поведения (режим login).

### `/admin/audit`
- Журнал действий админа.

---

## 7) Как создаются учётки пользователей (пошагово)

1. Войти в админку.
2. Перейти в **Clients** → создать клиента.
3. Открыть карточку клиента.
4. В блоке **Users** заполнить:
   - `Username`
   - `Password`
   - `User IP/CIDR`
5. Нажать **Create user**.

Результат:
- пользователь создан,
- IP/CIDR добавлен в whitelist с привязкой к этому пользователю.

---

## 8) Полезные переменные окружения

- `SERVER_ROLE` — `public`, `admin` или `all` (по умолчанию `all`)
- `LISTEN_PUBLIC_ADDR` — публичный адрес сервера (например `:8443`)
- `LISTEN_ADMIN_ADDR` — адрес админки (фиксирован `127.0.0.1:9443`)
- `PUBLIC_CERT_PATH`, `PUBLIC_KEY_PATH` — TLS для публичного сервера
- `PUBLIC_TLS_ENABLED` — по умолчанию `true`
- `ADMIN_TLS_ENABLED` — по умолчанию `true`
- `BOOTSTRAP_ADMIN_USER`, `BOOTSTRAP_ADMIN_PASSWORD` — первичный админ
- `DB_DSN` — Postgres DSN (если используете postgres build)

---

## 9) Мини-чек после запуска

1. Открывается админка на `127.0.0.1:9443`.
2. С внешней машины админка **не открывается**.
3. Без whitelist IP пользователь не попадает на публичные страницы.
4. Пользователь, созданный через админку, может войти только со своего whitelisted IP.
